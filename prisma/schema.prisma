// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  EMPLOYEE
  WORKER
}

model User {
  id           String  @id @default(cuid())
  name         String
  employeeCode String? @unique
  role         Role    @default(EMPLOYEE)
  email        String?
  pinHash      String?
  active       Boolean @default(true)
  defaultLocationId String?
  defaultLocation   Location? @relation("UserDefaultLocation", fields: [defaultLocationId], references: [id])
  phone         String?
  addressLine1  String?
  addressLine2  String?
  city          String?
  state         String?
  postalcode    String?
  adminNotes    String?
  documents     EmployeeDocument[]

  shifts                  Shift[]
  shiftCorrectionRequests ShiftCorrectionRequest[]

  hourlyRate   Float?  @default(0)
  salaryAnnnual Float?

  // PTO/Time-off settings
  ptoBalance   Float   @default(0)  // in days
  ptoRequests  TimeOffRequest[]

  // Notifications
  notifyEmail  Boolean @default(true)
  notifySms    Boolean @default(false)
  notifications Notification[]

  createdAt DateTime @default(now())
}

model EmployeeDocument {
  id              String   @id @default(cuid())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String

  title           String
  url             String           // can be Google Drive, Dropbox, etc.
  description     String?
  visibleToWorker Boolean  @default(true)

  createdAt       DateTime @default(now())
}

enum GeofencePolicy {
  STRICT  // Reject clock if outside radius
  WARN    // Allow clock but flag for admin review
}

model Location {
  id           String  @id @default(cuid())
  name         String
  code         String  @unique
  lat          Float
  lng          Float
  radiusMeters Float
  active       Boolean @default(true)

  // Geofence policy fields
  geofenceRadiusMeters Int             @default(60)
  clockInGraceSeconds  Int             @default(120)
  policy               GeofencePolicy  @default(STRICT)

  shifts       Shift[]
  defaultUsers User[]  @relation("UserDefaultLocation")
  shiftTemplates ShiftTemplate[]

  createdAt DateTime @default(now())
}

model Shift {
  id String @id @default(cuid())

  userId     String
  locationId String?

  clockIn  DateTime
  clockOut DateTime?

  clockInLat  Float?
  clockInLng  Float?
  clockOutLat Float?
  clockOutLng Float?

  notes String?

  user     User      @relation(fields: [userId], references: [id])
  location Location? @relation(fields: [locationId], references: [id])

  correctionRequests ShiftCorrectionRequest[]

  createdAt DateTime @default(now())
}

enum ShiftCorrectionType {
  MISSING_IN
  MISSING_OUT
  ADJUST_IN
  ADJUST_OUT
  NEW_SHIFT
}

enum CorrectionStatus {
  PENDING
  APPROVED
  REJECTED
}

model ShiftCorrectionRequest {
  id String @id @default(cuid())

  user   User   @relation(fields: [userId], references: [id])
  userId String

  // Optional link to the original shift (e.g., for adjusting in/out)
  shift   Shift?  @relation(fields: [shiftId], references: [id])
  shiftId String?

  type              ShiftCorrectionType
  requestedClockIn  DateTime?
  requestedClockOut DateTime?
  reason            String?

  status CorrectionStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ShiftTemplate {
  id          String  @id @default(cuid())
  name        String  // e.g., "Morning Shift", "Night Security"
  description String?

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  // Time of day (stored as minutes from midnight)
  startMinutes Int // e.g., 480 = 8:00 AM
  endMinutes   Int // e.g., 1020 = 5:00 PM (17:00)

  // Which days of the week (0=Sunday, 6=Saturday)
  daysOfWeek Int[] // e.g., [1,2,3,4,5] for Mon-Fri

  active Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum TimeOffType {
  PTO
  SICK
  VACATION
  UNPAID
  OTHER
}

enum TimeOffStatus {
  PENDING
  APPROVED
  REJECTED
}

model TimeOffRequest {
  id          String   @id @default(cuid())
  
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  
  type        TimeOffType
  status      TimeOffStatus @default(PENDING)
  
  startDate   DateTime
  endDate     DateTime
  
  daysRequested Float  // Partial days allowed (e.g., 0.5 for half day)
  reason      String?
  
  reviewedBy  String?  // Admin user ID
  reviewedAt  DateTime?
  reviewNotes String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId, status])
  @@index([startDate, endDate])
}

model Notification {
  id          String   @id @default(cuid())
  
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  
  type        String   // e.g., "shift_flagged", "correction_request", "pto_approved"
  title       String
  message     String
  
  read        Boolean  @default(false)
  relatedId   String?  // ID of related entity (shift, correction, pto request)
  
  createdAt   DateTime @default(now())
  
  @@index([userId, read])
}
